import './style.scss';
import { auth } from './firebase.js';
import { signOut, onAuthStateChanged } from "firebase/auth";
import { getFirestore, doc, getDoc, setDoc,query, where, updateDoc, addDoc, collection, getDocs } from "firebase/firestore";



const db = getFirestore();


  const dashboard = document.getElementById('dashboardSec');
  const profile = document.getElementById('profileSec');
  const booking = document.getElementById('bookingSec');
  const request = document.getElementById('requestSec');
  const dashboard_tab =  document.getElementById('dashboardTab')
  const profile_tab = document.getElementById('profileTab');
  const bookings_tab =  document.getElementById('bookingsTab')
  const request_tab = document.getElementById('requestTab');
  const refill_order = document.getElementById('refillOrder');
  const refill_btn = document.getElementById('refillBtn');
  const modify_btn = document.getElementById('modifyBtn'); 
  const save_btn = document.getElementById('saveBtn');

  const logout = document.getElementById('logout');

let currentUser = null;

  /* EmailJS Initialization */
     (function(){
      emailjs.init({
        publicKey: "UhBBBYsV5Pm9nqJgp",
      });
   })();

//onAuthStateChanged
onAuthStateChanged(auth, async (user) => {
  if (user) {

    currentUser = user;

    const userDocRef = doc(db, "users", user.uid);
    const userDocSnap = await getDoc(userDocRef);

    if (userDocSnap.exists()) {
      const userData = userDocSnap.data();
      document.getElementById("pName").textContent = `Hello, ${userData.name}`;
      /* document.getElementById("user-name").textContent = `Name: ${userData.name}`;
      document.getElementById("user-email").textContent = `Email: ${userData.email}`; */
    } else {
      console.log("No user data found in Firestore.");
    }
  } else {
    window.location.href = "/GasAgency/index.html";
  }
});
  //SignOut function
  logout.addEventListener('click', () => {    

    signOut(auth).then(() => {
      // Sign-out successful.
      /* alert('You are Signed Out.'); */
      window.location.href = '/GasAgency/index.html';
    }).catch((error) => {
      alert('An error occured:'+ error.Message);
      // An error happened.
    })
  });
 
  /* On cliking dashboard tab */
  dashboard_tab.addEventListener('click', (e) => {
    e.preventDefault();
    dashboard_tab.classList.toggle('active');
    dashboard.style.display = "flex";
    profile.style.display = "none";
    booking.style.display = "none";
    request.style.display = "none";
    profile_tab.classList.remove('active');
    bookings_tab.classList.remove('active');
    request_tab.classList.remove('active');

    document.getElementById('refill').style.display = "none";

  })

  /*On clicking profile tab - Fetching user data */
  profile_tab.addEventListener('click', async (e) => {
    e.preventDefault();

    profile_tab.classList.toggle('active');
    dashboard_tab.classList.remove('active');
    bookings_tab.classList.remove('active');
    profile.style.display = "flex";
    dashboard.style.display = "none";
    booking.style.display = "none";
    request.style.display = "none";
    request_tab.classList.remove('active');

    
    if(currentUser) {
    
    const docref = doc(db, 'users', currentUser.uid);
    const docSnap = await getDoc(docref);

    if(docSnap.exists()) {
      const userData = docSnap.data();

      document.getElementById('inputName').value = userData.name || "";
      document.getElementById('inputEmail').value = userData.email || "";
      document.getElementById('inputAadhar').value = userData.aadhar || "";
      document.getElementById('inputMobile').value = userData.mobile || "";
      document.getElementById('inputAddress').value = userData.address || "";
    } 
  } 
  })
  /* Onclicking the bookings tab */
  bookings_tab.addEventListener('click', async (e) => {
    e.preventDefault();
    profile_tab.classList.remove('active');
    dashboard_tab.classList.remove('active');
    bookings_tab.classList.toggle('active');   
    profile.style.display = "none";
    dashboard.style.display = "none";
    request.style.display = "none";
    booking.style.display = "flex";
    request_tab.classList.remove('active');  
    

    const tableBody = document.getElementById('bookingLists');    
    tableBody.innerHTML = '';
    const userOrderRef = collection(db, 'orders', currentUser.uid, 'userOrders');
    const userDataSnap = await getDocs(userOrderRef);

    userDataSnap.forEach((doc) => {
      const data = doc.data();

      const row = document.createElement('tr');

      row.innerHTML = `<td>${data.dateOfOrder}</td>
                       <td>${data.idOfOrder}</td>
                       <td>${data.Amount}.00</td>
                       <td>${data.status || 'Pending'}</td>
                       <td><button  class ='btnPrimary payNow' type="button">Pay Now</button></td>`; 
                       
      tableBody.appendChild(row);
           
    });

  })

  /* Onclicking requests tab */  
  request_tab.addEventListener('click', async (e) => {
    e.preventDefault();
    request_tab.classList.toggle('active');
    request.style.display = "flex";    
    profile.style.display = "none";
    booking.style.display = "none";
    dashboard.style.display = "none";
    profile_tab.classList.remove('active');
    bookings_tab.classList.remove('active');
    dashboard_tab.classList.remove('active');

    const requestTable = document.getElementById('userRequestsHistory');
    requestTable.innerHTML = ''; //Refresh data.
    
    let SlNo = 1;
    const cylRequestRef = collection(db, 'db_CylinderReq');
    const q = query(cylRequestRef, where('uid', '==', currentUser.uid));
    const querySnapShot = await getDocs(q);
    
    
    querySnapShot.forEach(doc => {      
    const  reqData = doc.data();

      const row = document.createElement('tr');

      row.innerHTML = `<td>${SlNo++}</td>
                       <td>${reqData.date}</td>
                       <td>${doc.id}</td>                       
                       <td>${reqData.status === '' ? 'Pending' : reqData.status}</td>`;

      requestTable.appendChild(row);

    })

  })

  /* Additional cylinder order process */
  document.getElementById('addCylCheckBox').addEventListener('change', async function () {
    if(this.checked) {
      
      
      document.getElementById('addCylinder').classList.remove('inActive');
      
    } else {
      document.getElementById('addCylinder').classList.add('inActive');
      document.getElementById('addCylinder').classList.remove('active');
      document.getElementById('addCylinder').disabled = 'true';
      
    }
  })

  /* Onclicking Additional Cylinder Request button */
document.getElementById('addCylinder').addEventListener('click', async () => {
  try {
    ['declaration', 'checkBox', 'addCylinder'].forEach(id => {
      document.getElementById(id).style.display = 'none';
    });

    const now = new Date();
    const day = now.getDate();
    const month = now.getMonth() + 1;
    const year = now.getFullYear();
    const currDate = `${day}/${month}/${year}`;

    // Fetch user data from Firestore
    const userRef = doc(db, 'users', currentUser.uid);
    const userSnap = await getDoc(userRef);
    const userData = userSnap.exists() ? userSnap.data() : {};

    const bookinsRef = doc(db, 'Bookings', currentUser.uid );
    const bookingSnap = getDoc(bookinsRef);
    const bookingsData = (await bookingSnap).data();
    const cylinder_request_ref = collection(db, 'db_CylinderReq');
    if(bookingsData.CylCount === 0){
    await addDoc(cylinder_request_ref, {
      name: userData.name || "Unnamed User",
      uid: currentUser.uid,
      date: currDate,
      status: ''
    });
  } else {
    alert("Cylinders are available in your account");
  }
    const messageStatus = document.getElementById('confirmMsg');
    messageStatus.style.cssText = 'display:block; width:50%; font-size:1.6rem;';
    messageStatus.textContent = 'Your request is received and under review. An email will be sent to your registered email ID for further communication.';
  } catch (error) {
    const errorMsg = error.message || 'Unknown error';
    alert('Error in processing additional cylinder: ' + errorMsg);
  }
});
  
  /* Onclicking modify button input field will become active for editing */
  document.getElementById('modifyBtn').addEventListener('click', () => {

    ['inputName', 'inputEmail', 'inputAadhar', 'inputMobile', 'inputAddress', 'saveBtn'].forEach((id) => {

     document.getElementById(id).disabled = false;

    })


    modify_btn.disabled = true;
    modify_btn.classList.add("inActive");
    modify_btn.classList.remove("btnPrimary");
    document.getElementById('saveBtn').classList.add('btnPrimary');   
   

  })
/* Onclicking the save button */
  save_btn.addEventListener('click', async (e) => {
  e.preventDefault();

  if(!currentUser) {
    alert('User not Logged in');
    window.location.href = '/GasAgency/index.html';
  }
      
   const userDocRef = doc(db, 'users', currentUser.uid);

   const updatedData = {
    name: document.getElementById("inputName").value.trim(),
    email: document.getElementById("inputEmail").value.trim(),
    aadhar: document.getElementById("inputAadhar").value.trim(),
    mobile: document.getElementById("inputMobile").value.trim(),
    address: document.getElementById("inputAddress").value.trim(),
  };

  try {
    await updateDoc(userDocRef, updatedData);

    // Disable fields again
    ["inputName", "inputEmail", "inputAadhar", "inputMobile", "inputAddress", "saveBtn"].forEach(id => {
      document.getElementById(id).disabled = true;
    });

    document.getElementById("saveBtn").classList.remove("btnPrimary");

    alert("Profile updated successfully!");
  } catch (error) {
    console.error("Error updating profile:", error);
    alert("Failed to update profile.");
  }

  modify_btn.disabled = false;
  modify_btn.classList.add('btnPrimary');
  modify_btn.classList.remove('inActive');

  })
/* On clicking the request-refill icon */
  document.getElementById('request').addEventListener('click', async (e) => {
    e.preventDefault();
  
    document.getElementById('refill').style.display = "flex";
    

    if(currentUser) {
      
      const docref = doc(db, 'users', currentUser.uid);
      const docBookRef = doc(db, 'Bookings', currentUser.uid)
      const docSnap = await getDoc(docref);
      const docBookSnap = await getDoc(docBookRef);
      document.getElementById('regNum').value = currentUser.uid

    if(docSnap.exists()) {
      const userData = docSnap.data();
      const bookingData = docBookSnap.data();

      document.getElementById('mName').value = userData.name || "";
      document.getElementById('mNum').value = userData.mobile || "";
      document.getElementById('mAdd').value = userData.address || "";
      document.getElementById('cylCount').value = bookingData.CylCount || "0";

          if(Number(bookingData.CylCount) === 0) {
          refill_btn.innerHTML= '';
          const divEle = document.createElement('div');
          divEle.innerHTML = "<h2>You have ran-out of your alloted cylinders.</h2><h3>Go to Requests tab and Request Extra Cylinders</h3>";
          divEle.style.cssText = "display:flex; flex-direction:column; gap: 0.8rem;text-align:center; letter-spacing:1px;";
          refill_btn.appendChild(divEle);                   
          }
    }       
      ['regNum', 'mName', 'mNum', 'mAdd', 'cylCount'].forEach((id) => {
      document.getElementById(id).disabled = 'true';
      })


    }
  }) 

  /* Confirm Order Button */   
  refill_order.addEventListener('submit', async (e) => {
  e.preventDefault();

      const regNum = document.getElementById('regNum').value;
      const mName = document.getElementById('mName').value;
      const mNum = document.getElementById('mNum').value;
      const mAdd = document.getElementById('mAdd').value;
      const cylCount = document.getElementById('cylCount').value;

                
      if(!regNum || !mName || !mNum || !mAdd || !cylCount){
    alert("Please Complete Your Profile in your Profile section!");
    return;
  } 
  const now = new Date();
  const day = now.getDate();
  const month = now.getMonth() + 1;
  const year = now.getFullYear();
  const orderDate = `${day}/${month}/${year}`;
  const orderId = `${day}${month}${year}${currentUser.uid.slice(0,4).toUpperCase()}${Math.floor(Math.random() * 1000)}`;
  const payableAmt = 990.00;
  
  const CylOrderRef = collection(db, 'orders', currentUser.uid, 'userOrders');
  const bookingRec = doc(db, 'Bookings', currentUser.uid);

        addDoc(CylOrderRef, {
              dateOfOrder: orderDate,
              idOfOrder: orderId,
              Amount: payableAmt
        })
        
  const bookingSnap = await getDoc(bookingRec);
  if( bookingSnap.exists()){
      
          const bookingData =  bookingSnap.data()
          const updateCylCount = bookingData.CylCount - 1; //Updating the cylinder count.
    
          await updateDoc(bookingRec,{
               CylCount: updateCylCount
               });
    
    }
  
    /* Sending Email after confirming Order */
    const sendEmail = currentUser.email;
    var msgParams = {        
                      name:mName,
                      email: sendEmail,
                      price: payableAmt,
                      order_id:orderId
                       }  
        emailjs.send('service_texmdlm', 'template_roi2uta', msgParams)
        alert(`'Order Placed Succesfully Order Id: ${orderId}, Email sent, check SPAM folder' `);
        document.getElementById('refill').style.display = 'none';        
  })


  /* Cancel Button */
  document.getElementById('BtnCancel').addEventListener('click', () => {
   
  document.getElementById('refill').style.display = 'none';
})

/* mobile menu */
const mobile_Home = document.getElementById('mobileHome');
mobile_Home.addEventListener('click', (e) => {
e.preventDefault();

const mobileNavBox = document.getElementById('mobileNavBox');
const icon = document.getElementById('icon');

if (mobileNavBox.style.display === 'flex') {
  mobileNavBox.style.display = 'none';
  icon.classList.remove( "fa-xmark");
  icon.classList.add("fa-bars");
   
} else {
  mobileNavBox.style.display = 'flex';
  icon.classList.add( "fa-xmark");
  icon.classList.remove("fa-bars");
}
})




